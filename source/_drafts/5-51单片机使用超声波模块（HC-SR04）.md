---
title: 5. 51单片机使用超声波模块（HC-SR04）
categories:
  - 单片机
  - 51单片机
tags:
  - 51单片机
  - 超声波模块
---

### 说明
TRIG接P0_0
ECHO接P0_1

<!-- more -->

### 代码
```c
#include <mcs51/8051.h>
#include <stdio.h>
#define __nop__ __asm nop __endasm

#define TRIG P0_0
#define ECHO P0_1

__bit isOverstep = 0;
// 返回时间
unsigned int time, distance;

void count()
{
  time = TH0 * 256 + TL0;
  TH0 = 0;
  TL0 = 0;
  // 算出来是CM
  distance = (time * 1.87) / 100;
  if(isOverstep)
  {
    isOverstep = 0;
    printf("overstep\n");
  } else {
    printf("distance = %d\n", distance);
  }
}

void trigger()
{
  TRIG = 1;
  __nop__; __nop__; __nop__; __nop__; __nop__;
  __nop__; __nop__; __nop__; __nop__; __nop__;
  __nop__; __nop__; __nop__; __nop__; __nop__;
  __nop__; __nop__; __nop__; __nop__; __nop__;
  TRIG = 0;
}

void setup()
{
  TMOD = 0x21;
  SCON = 0x50;
  TH1 = 0XFD;
  TL1 = 0XFD;
  TH0=0;
  TL0=0;
  TR0=1;
  ET0=1;
  TR1=1;
  TI=1;
  EA=1;
}

void loop()
{
  trigger();
  while(!ECHO);
  TR0 = 1;
  while(ECHO);
  TR0=0;
  count();
}

void timer0() __interrupt 1
{
  isOverstep = 1;
}

void main()
{
  setup();
  while(1) loop();
}

void putchar(char c)
{
  SBUF = c;
  while(!TI);
  TI = 0;
}
```

### 串口输出
{% asset_img 1.gif %}
